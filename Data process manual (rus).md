Обработка данных в OriginPro.
=============================

Представленный набор программ и скриптов для пакета OriginPro разрабатывался как средство автоматизации обработки большого массива данных, получаемых с цифровых осциллографов в процессе научно-исследовательской (экспериментаторской) деятельности. Программы и скрипты требуют аккуратной настройки для каждого конкретного набора данных (под каждый эксперимент), затем вся обработка и построение графиков проходит в автоматическом режиме. Чем меньше параметры нового набора данных отличаются от уже обработанного, тем меньше правок придется вносить в настройки скриптов.

Дополнительная информация о программировании для OriginPro:
* [Origin C programming reference](https://www.originlab.com/doc/OriginC/guide "OriginLab User Guide")
* [LabTalk programming](https://www.originlab.com/doc/LabTalk "OriginLab User Guide")

##### Терминология
* **сигнал** - данные с датчика, записанные в виде зависимости амплитуды от времени (непрерывной последовательности пар дискретных значений время-амплитуда).
* **кривая** - *сигнал* в графическом представлении (*кривая* на графике).
* **выстрел** - одно событие, записанное на осциллограф(ы) (или любые другие устройства) в виде *сигналов* с датчиков (зависимость амплитуды параметра от времени). В большинстве случаев связано с однократным запуском экспериментальной установки. К примеру, однократный запуск установки по исследованию высоковольтных газовых разрядов, как следствие - генерация однократного разряда, сопровождающегося громким хлопком,- отсюда такой термин.
* **серия** - серия *выстрелов*, обычно объединенных определенными общими параметрами запуска установки или свойствами исследуемого объекта или настройками датчиков.
* **сырые/исходные данные** - сигналы с датчиков, записанные в цифровом виде, не прошедшие никакой обработки.
* **таблица/WorksheetPage/WorkBook** - таблица в OriginPro, которая может содержать множество слоев (страниц), каждый из которых представляет собой двумерную таблицу. Проект OriginPro может состоять из неограниченного количества таких таблиц.
* **имя** - значение параметра ShortName какого-либо объекта в OriginPro

##### Представленные программы и скрипты позволяют:
* подготовить импортированные сырые данные к обработке
* провести независимую коррекцию каждого сигнала (кривой): учет корректирующий коэффициентов, вычитание постоянной составляющей, сдвиг по временной оси для всех выстрелов серии, а также индивидуально для каждого конкретного выстрела.
* построить множество 2D графиков (практически любой сложности) по образцу для каждого выстрела в серии
* построить графики с наложением сигналов с определенных датчиков из указанных выстрелов серии
* проанализировать сигналы на наличие пиков и построить таблицу с параметрами пиков (момент времени, амплитуда, ширина и т.д.) по выстрелам.

##### Алгоритм обработки данных
* Подготовить файлы исходных данных
* Импортировать исходные данные в OriginPro
* С помощью скриптов подготовить данные к обработке
* Обработать данные с помощью программы ProcessSignals
* Построить графики с помощью ProcessGraph

Как использовать программы на OriginC
-------------------------------------

Программы на OriginC состоят из двух файлов с одинаковым именем и разными расширениями:
* Файл .opj - проект OriginPro с таблицами для ввода параметров. Он добавляется в проект с исходными данными, которые необходимо обработать (меню File -> Append). На первой странице таблицы параметром расположена кнопка, запускающая процесс обработки.
* Файл .c с кодом программы. Он добавляется в рабочее пространство компилятора один раз и ~~навсегда~~ пока вы его оттуда сами не удалите.

Чтобы программа работала нужно файл с ее кодом (.c) добавить в рабочее пространство компилятора для этого откройте CodeBuilder (шестеренка на панели инструментов OriginPro или Alt+4)

[<img src="https://github.com/shpakovkv/OriginPro/blob/master/res/codebuilder_open.png?raw=true" alt="codebuilder_open" height="150">](https://github.com/shpakovkv/OriginPro/tree/master/res/codebuilder_open.png)

В CodeBuilder'е откройте файл кода ".c", затем добавьте его в рабочее пространство - меню File -> add to Workspace или Ctrl+W. После этого в окне Workspace в папке User должен появиться этот файл.

[<img src="//res/codebuilder_addtoworkspace.png?raw=true" alt="codebuilder_addtoworkspace.jpg" height="300">](//res/codebuilder_addtoworkspace.png)

Скомпилируйте код (Build -> Rebuild All или Alt+8) и убедитесь, что компилирование закончилось успешно (в окне Output в самой нижней строчке должно быть ссобщение "Done!").

[<img src="//res/codebuilder_builddone.png" alt="codebuilder_builddone.jpg" height="300">](//res/codebuilder_builddone.png)

Таким образом в рабочее пространство CodeBuilder'а в папку User можно добавить несколько файлов .c и все они останутся там даже после перезапуска OriginPro. Но чтобы они работали при каждом перезапуске OriginPro необходимо открывать CodeBuilder и запускать процесс компиляции (Alt+8), после чего можно закрыть CodeBuilder, при этом все скомпилированные программы будут доступны из окна OriginPro до его закрытия.

В файлах ProcessSignals.opj, ProcessGraph.opj, SignalAnalysisProcess.opj (добавляемых в проект с данными, которые необходимо обработать) есть таблица с параметрами обработки. На первой странице этой таблицы находится кнопка "Process", запускающая соответствующую обработку согласно записанным в таблице параметрам.

Программа AllInOneGraph запускается через LabTalk скрипт (там же настраиваются параметры) и не имеет таблицы-интерфейса.

Как использовать скрипты LabTalk
--------------------------------

Краткий алгоритм работы со скриптами:
1. Измененить параметры скрипта под задачу
2. Скопировать весь код в Command Window (Ctrl+A, Ctrl+C, Ctrl+V) и запустить (Enter)

Все LabTalk скрипты записаны отдельными файлами ".c". В начале такого фала находится (в виде комментария к коду) краткое описание скрипта и как им пользоваться. Далее идет блок с настройками  в виде присвоения переменным определенных значений. Настройка скрипта заключается в изменении этих значений. Пример скрипта (LabTalk_SaveLayersToCSVs.c):

```
/*
Discription:
Save all layers of selected WorksheetPage(s) as .csv files
to the specified folder

How to use:
1) Choose WorksheetPage with layers to be exported
2) Get ShortName of that WorksheetPage
3) Assign that name to the variable "bookNames"
4) Create a folder for exported files
5) Specify the path to that folder via variable saveToPath$
7) Copy below script and paste it into the Origin's Command Window
8) Press Enter
*/

//==========================================================
// SETUP
StringArray bookNames;
bookNames.Add("OutDPO7054");
bookNames.Add("OutLeCroy");
bookNames.Add("OutTDS3054BL");
bookNames.Add("OutTDS3054BR");
bookNames.Add("OutTDS2024C");

string saveToPath$ = "C:\temp\temp";

//===========================================================
// PROCESS
path_len = saveToPath.GetLength();
if (saveToPath.GetAt(path_len) != 92)
{
	saveToPath.Insert(path_len + 1, '\');
}

for (bb = 1; bb<=bookNames.GetSize(); bb++)
{
	window -a %(bookNames.GetAt(bb)$);
	int layers_count = page.nLayers;
	for (ii=1; ii<=layers_count; ii++)
	{
		page.active = ii;
		string save_as$ = saveToPath$ + bookNames.GetAt(bb)$ + "_" + wks.name$ + ".csv";
		//save_as$=;
		expASC type:=csv path:=save_as$ csvsep:=Semicolon longname:=0 units:=0 comment:=0;
	}
}
```

После настроек идет сам код скрипта. Там можно подправить логику работы скрипта, если это вам зачем-то понадобилось, и при этом вы разбираетесь в коде и знаете, что делаете.

После настройки скрипта скопируйте его (Ctrl+A, Ctrl+C). Откройте свой проект в OriginPro, откройте Command Window (меню Window -> Command Window или Alt+3).

![labtalk_commandwindow.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/labtalk_commandwindow.png?raw=true "Command Window")

Вставьте туда скрипт и запустите на выполнение (Enter).

Подготовка файлов исходных данных
---------------------------------
* Данные **должны** быть записаны в текстовом формате (**CSV, TXT, DAT**)
* Данные по кривым **должны** храниться в виде двумерной таблицы - **по два столбца на кривую** (отсчеты по времени и амплитуде). *Некоторые осциллографы (например Rohde&Schwarz HMO series) записывают в файл один столбец с отсчетами по времени и несколько с отсчетами по амплитуде. Такие файлы необходимо отредактировать, чтобы у каждого столбца амплитуд слева стоял свой столбец времени.*
* Если в ходе экспериментов данные с датчиков записывались несколькими запоминающими устройствами, то мы имеем N*K файлов, где N - количество выстрелов, K - количество файлов, записанных за один выстрел. Для корректного импорта данных из этих файлов **рекомендуется именовать файлы определенным образом**:

    * **<span style="color:#156cc7">[prefix]</span><span style="color:#00b117">[N-number]</span><span style="color:#bf5021">[separator]</span><span style="color:#00b117">[K-number]</span><span style="color:#156cc7">[postfix]</span>.<span style="color:#c80000">[ext]</span>**

    * **<span style="color:#156cc7">[prefix]</span>** - одинаковый для всех файлов префикс имени файла. Чем он короче, тем лучше. Должен заканчиваться нецифровым символом. Может отсутствовать.

    * **<span style="color:#00b117">[N-number]</span>** - номер выстрела с лидирующими нулями (например, 0001). Важно, чтобы во всех файлах количество символов этого номера совпадало.

    * **<span style="color:#bf5021">[separator]</span>** - любая последовательность символов, разделяющая числа N-number и K-number.

    * **<span style="color:#00b117">[K-number]</span>** - номер или название записывающего устройства или канала записи.

    * **<span style="color:#156cc7">[postfix]</span>** - одинаковый для всех файлов постфикс имени файла. Должен начинаться с нецифрового символа. Может отсутствовать.

    * **<span style="color:#c80000">[ext]</span>** - расширение файла.

    * Пример имени файла: **<span style="color:#00b117">0047</span><span style="color:#bf5021">-osc</span><span style="color:#00b117">01</span><span style="color:#156cc7">-signals</span>.<span style="color:#c80000">csv</span>** == [][0047][-osc][01][-signals].[csv]
* Если в ходе эксперимента были сбои записи и некоторые файлы отсутствуют, но остальные данные в этом выстреле необходимо обработать несмотря ни на что, то пропущенные файлы **необходимо заменить на пустышки** (файлы с точно такой же структурой но "без данных"). Проще всего это сделать, скопировав и переименовав соответствующий файл из другого выстрела и удалить большую часть данных, оставив 3-5 строк с данными (в идеале обнулив все числа, не меняя количество "столбцов") и строки заголовка (header lines).

Импорт CSV
----------
В большинстве случаев исходные данные представляют собой набор из **N*K** файлов, где **N** - количество выстрелов, **K** - количество файлов, приходящихся на один выстрел (при этом каждый файл записан отдельным устройством или каналом записи). В такой ситуации есть два подхода к импорту:
1. Импорт всех файлов в одну таблицу Origin. Тогда в таблице появится **N*K** слоев. *Для старых версий OriginPro максимальное количество слоев в таблице равно 255.*
2. Импортировать данные с каждого устройства записи в отдельную таблицу. Тогда мы получим **K** таблиц и **N** слоев в каждой.

![import_menu.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/import_menu.png?raw=true "Import Files")

Перед импортом необходимо создать новую пустую таблицу (empty Workbook Window) и выделить ее (сделать активным ее окном). Импорт файлов ".csv" осуществляется через пункт меню File -> Import -> Comma Delimited (CSV), который открывает диалоговое окно выбора файлов. Сразу несколько файлов можно выбрать через Ctrl или Shift. После выбора файлов необходимо добавить их в список импорта кнопкой "«Add File(s)". После составления списка импорта следует удостовериться, что все файлы идут по списку в нужной последовательности, и затем нажать "Ok". После этого появится диалоговое окно выбора параметров импорта.

![import_parameters.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/import_parameters.png?raw=true "Import Files")

##### Import Options
* **Delimeter** - тип разделителя лучше установить вручную. Во всех файлах, импортируемых одновременно, тип разделителя **должен быть одинаковый**.
* **1st File Import Mode** - параметры импорта первого файла:
  * Чтобы импортировать данные в пустую таблицу выберите Replace Existing Data.
  * Чтобы дополнить имеющуюся таблицу новыми слоями с импортируемыми данными - выберите Starts New Sheets.
* В параметре импорта группы файлов (**Multifile Import Mode**) следует выбрать пункт Starts New Sheets (для удобной работы со скриптами).

##### Header Lines
* В пункте Number Of Main Header Lines необходимо указать количество строк заголовка файла (которое можно узнать, открыв файл с данными в текстовом редакторе).
* Если в  импортируемых одновременно файлах размер заголовка отличается, то нужно указать максимальное количество строк *(при этом из файлов количеством HeaderLines на N меньше указанного при импорте будет вырезано N первых строк данных,- это нужно учитывать).*

![csv_headerlines.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/csv_headerlines.png?raw=true "Header Lines")

##### Partial Import
Некоторые осциллографы записывают в файл с данными пустые колонки, такие пустые ячейки могут вызвать ошибки в работе программ и скриптов. Их необходимо пропустить при импорте:
* **Start Col** - пропустить все колонки до этого номера (нумерация начинается с 1)
* **End Col** - пропустить все колонки после этого номера

![import_partial.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/import_partial.png?raw=true "Partial Import")

Подготовка таблиц
-----------------
У каждой таблицы, графика и любого другого "окна" в OriginPro есть параметр **ShortName** - это уникальное **имя** объекта, по которому к нему может обратиться скрипт или программа. ShortName может состоять только из последовательности латинских букв (регистр имеет значение!) и цифр, не может начинаться с цифры и не может превышать 13 символов. У двух разных объектов OriginPro не может быть одинаковых имен.

![book_shortname.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/book_shortname.png?raw=true "Unique ShortName")

Также у каждого объекта в OriginPro есть параметр **LongName** - это заголовок, который может содержать большое количество почти любых символов (в т.ч. русские буквы). Этот параметр ни на что не влияет и может совпадать у разных объектов.

После импорта должно получиться несколько таблиц с **N*K** слоями, где **N** - это количество выстрелов и для всех таблиц оно одинаково, **K** - это количество осциллографов/каналов записанных отдельными файлами и импортированных в одну таблицу, **K > 0**, и для каждой таблицы **K** свое.

![book_layernames.jpg](https://github.com/shpakovkv/OriginPro/tree/master/res/book_layernames.png?raw=true "Layers")

Для удобства, а также корректной работы программы построения графиков необходимо, чтобы имена всех слоев таблиц начинались с 4х-значного номера выстрела. Если файлы с данными были пронумерованы в соответствии с предложенной выше рекомендацией ([prefix][N-number][separator][K-number][postfix].[ext]), то привести имена слоев к требуемому виду можно с помощью скрипта **LabTalk_LayersNameCutter.c**, т.к. имя каждого слоя совпадает с именем файла, данные из которого были импортированы на этот слой. Все, что нужно сделать, это вырезать prefix и, по желанию, postfix. Для этого открываем файл скрипта и в блоке SEUP настраиваем параметры:

```
// SETUP

// add the short names of the target books
StringArray BookName = {"Book1", "Book2"};  // the list of the WorksheetPages to be processed

// the index of the first letter to be left (previous letters will be deleted)
// NOTE: the index of the first letter is 1
int StartIdx = 5;

// the number of characters to be left (all the others will be deleted)
int CharCount = 11;
```
* **BookName** - список имен таблиц, имена слоев которых необходимо обрезать на заданное количество символов
* **StartIndex** - количество символов префикса
* **CharCount** - суммарное количество символов N-number, или N-number + separator + K-number, если в таблицу импортированы данные с нескольких осциллографов/каналов.

**Альтернативный вариант:** если нумерация выстрелов непрерывная (без пропусков), то можно использовать скрипт **LabTalk_LayerRenamer.c**, тогда изначальная нумерация файлов (и соответственно слоев таблиц) не имеет значения - скрипт пронумерует слои последовательно, начиная с заданного номера:

```
// SETUP
StringArray bookNames = {"Book1", "Book2"};  // list of books whose layers need to be renamed

// by default the number of the first layer/group is 1
// but you can increase/decrease it by this parameter
int increment = 0;

// the name of the layers will be a number with leading zeros
// with this total number of digits
int layerNumberDigits = 4;  

// group members (layers) names
StringArray grNames = {"CH1", "CH2", "CH3"};
```
* **bookNames** - список имен таблиц, имена слоев которых необходимо пронумеровать
* **increment** - по умолчанию нумерация начинается с номера 1, но это значение можно увеличить/уменьшить
* **layerNumberDigits** - количество символов в номере (не более 4)
* **grNames** - "имена групп". Если в каждую таблицу импортированы данные с одного осциллографа/канала (на каждый выстрел приходится только одна страница с данными), то эту переменную нужно оставить пустой ```StringArray grNames = {};```. В противном случае тут указываются короткие обозначения осциллографов/каналов (например: osc1, CH2, и т.д.) которые будут одинаковыми для всех таблиц, указанных в списке **bookNames**. Если во всех таблицах разное количество страниц приходится на один выстрел, то данный скрипт нужно запускать несколько раз (для каждой таблицы отдельно) с разными параметрами.

Обработка данных (ProcessSignals)
---------------------------------
*Описание в разработке*

Построения графиков (ProcessGraph)
------------------------------------------------
*Описание в разработке*

Графики вида All-in-one
-----------------------
*Описание в разработке*

Анализ пиков
------------
*Описание в разработке*
